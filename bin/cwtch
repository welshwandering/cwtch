#!/bin/bash
# cwtch - Manage Claude Code profiles and configuration.
# shellcheck disable=SC2154
set -euo pipefail

SCRIPT_PATH="$0"
while [[ -L "${SCRIPT_PATH}" ]]; do
  DIR="$(cd "$(dirname "${SCRIPT_PATH}")" && pwd)"
  SCRIPT_PATH="$(readlink "${SCRIPT_PATH}")"; [[ "${SCRIPT_PATH}" != /* ]] && SCRIPT_PATH="${DIR}/${SCRIPT_PATH}"
done
SCRIPT_DIR="$(cd "$(dirname "${SCRIPT_PATH}")" && pwd)"
# shellcheck source=../lib/common.sh
source "${SCRIPT_DIR}/../lib/common.sh"
# shellcheck source=../lib/config.sh
source "${SCRIPT_DIR}/../lib/config.sh"
# shellcheck source=../lib/sync.sh
source "${SCRIPT_DIR}/../lib/sync.sh"

get_version() {
  local version_file="${SCRIPT_DIR}/../VERSION"
  [[ -f "${version_file}" ]] && tr -d '\n' < "${version_file}" || echo "dev"
}

get_git_sha() {
  git -C "${SCRIPT_DIR}" rev-parse --short HEAD 2>/dev/null || echo "unknown"
}

check_latest_version() {
  local latest; latest="$(curl -sf "https://api.github.com/repos/agh/cwtch/releases/latest" 2>/dev/null | jq -r '.tag_name // empty' | sed 's/^v//')"
  echo "${latest}"
}

version_gt() {
  # Returns 0 if $1 > $2 using semantic versioning
  [[ "$(printf '%s\n%s' "$1" "$2" | sort -V | head -1)" != "$1" ]]
}

cmd_version() {
  local version; version="$(get_version)"
  local sha; sha="$(get_git_sha)"

  echo -e "${C_BOLD}cwtch${C_RESET} ${C_CYAN}v${version}${C_RESET} ${C_DIM}(${sha})${C_RESET}"
  echo ""

  # Check for updates
  echo -e "${C_DIM}Checking for updates...${C_RESET}"
  local latest; latest="$(check_latest_version)"
  if [[ -n "${latest}" ]]; then
    if version_gt "${latest}" "${version}"; then
      echo -e "${C_YELLOW}${SYM_ARROW}${C_RESET} New version available: ${C_GREEN}v${latest}${C_RESET}"
      echo ""
      echo -e "  Update with: ${C_CYAN}brew upgrade cwtch${C_RESET}"
    else
      echo -e "${C_GREEN}${SYM_CHECK}${C_RESET} You're running the latest version"
    fi
  else
    dim "  Could not check for updates"
  fi
  echo ""
}

usage_help() {
  local version; version="$(get_version)"
  echo -e "${C_BOLD}cwtch${C_RESET} ${C_DIM}v${version} â€” profiles & config for Claude Code${C_RESET}"
  echo ""
  echo -e "${C_BOLD}USAGE${C_RESET}"
  echo -e "  cwtch ${C_CYAN}<command>${C_RESET} [args]"
  echo ""
  echo -e "${C_BOLD}COMMANDS${C_RESET}"
  echo -e "  ${C_CYAN}status${C_RESET}                 Show profile, usage, and sync state"
  echo -e "  ${C_CYAN}usage${C_RESET}                  Show usage for all profiles"
  echo -e "  ${C_CYAN}refresh${C_RESET} [name] [-q]    Refresh expired OAuth tokens"
  echo ""
  echo -e "  ${C_CYAN}sync${C_RESET}                   Pull sources and build ~/.claude/"
  echo -e "  ${C_CYAN}sync init${C_RESET}              Create example Cwtchfile"
  echo -e "  ${C_CYAN}sync check${C_RESET}             Validate Cwtchfile"
  echo ""
  echo -e "  ${C_CYAN}profile list${C_RESET}           List saved profiles"
  echo -e "  ${C_CYAN}profile setup${C_RESET} <name>   Create & save long-lived token (easiest)"
  echo -e "  ${C_CYAN}profile save-token${C_RESET} <n> Save existing long-lived token"
  echo -e "  ${C_CYAN}profile save-key${C_RESET} <n>   Save API key profile"
  echo -e "  ${C_CYAN}profile save${C_RESET} <name>    Save OAuth credential as profile"
  echo -e "  ${C_CYAN}profile use${C_RESET} <name>     Switch to profile"
  echo -e "  ${C_CYAN}profile delete${C_RESET} <name>  Delete a profile"
  echo -e "  ${C_CYAN}profile env${C_RESET}            Output export for current profile"
  echo -e "  ${C_CYAN}profile token${C_RESET}          Output current profile's token"
  echo -e "  ${C_CYAN}profile api-key${C_RESET}        Output current profile's API key"
  echo ""
  echo -e "  ${C_CYAN}edit${C_RESET}                   Edit Cwtchfile"
  echo -e "  ${C_CYAN}version${C_RESET}                Check version and updates"
  echo ""
}

cmd_sync() {
  if [[ $# -lt 1 ]]; then do_sync; return; fi
  local sub="$1"; shift
  case "${sub}" in
    init) sync_init ;;
    check) config_check ;;
    *) err "Unknown sync command: ${sub}"; exit 1 ;;
  esac
}

cmd_profile() {
  [[ $# -lt 1 ]] && { err "Missing profile subcommand"; usage_help; exit 1; }
  local sub="$1"; shift
  case "${sub}" in
    list) profile_list ;;
    current) [[ -f "${CURRENT_FILE}" ]] && cat "${CURRENT_FILE}" || echo "(none)" ;;
    setup)      [[ $# -lt 1 ]] && { err "Missing name"; exit 1; }; cmd_setup "$1" ;;
    save)       [[ $# -lt 1 ]] && { err "Missing name"; exit 1; }; profile_save "$1" ;;
    save-key)   [[ $# -lt 1 ]] && { err "Missing name"; exit 1; }; cmd_save_key "$1" ;;
    save-token) [[ $# -lt 1 ]] && { err "Missing name"; exit 1; }; cmd_save_token "$1" ;;
    use)        [[ $# -lt 1 ]] && { err "Missing name"; exit 1; }; profile_use "$1" ;;
    delete)     [[ $# -lt 1 ]] && { err "Missing name"; exit 1; }; profile_delete "$1" ;;
    api-key)    cmd_apikey ;;
    token)      cmd_token ;;
    env)        cmd_env ;;
    *) err "Unknown profile command: ${sub}"; exit 1 ;;
  esac
}

cmd_save_key() {
  local name="$1" key; [[ -t 0 ]] && { read -rsp "API key: " key; echo; } || read -r key
  [[ -z "${key}" ]] && { err "No API key provided"; exit 1; }; profile_save_key "${name}" "${key}"
}

cmd_save_token() {
  local name="$1" token; [[ -t 0 ]] && { read -rsp "Token: " token; echo; } || read -r token
  [[ -z "${token}" ]] && { err "No token provided"; exit 1; }; profile_save_token "${name}" "${token}"
}

cmd_setup() {
  local name="$1"
  info "Running claude setup-token..."
  echo ""
  local output; output="$(claude setup-token 2>&1)" || { err "Failed to run claude setup-token"; return 1; }
  echo "${output}"
  local token; token="$(echo "${output}" | grep -oE 'sk-ant-oat01-[a-zA-Z0-9_-]+')"
  [[ -z "${token}" ]] && { err "Could not extract token from output"; return 1; }
  echo ""
  profile_save_token "${name}" "${token}"
  echo ""
  info "To use this profile, run:"
  echo -e "  ${C_CYAN}eval \"\$(cwtch profile env)\"${C_RESET}"
}

cmd_apikey() {
  local key; key="$(get_current_apikey)" || { err "Current profile is not an API key profile"; exit 1; }
  echo "${key}"
}

cmd_token() {
  local token; token="$(get_current_token)" || { err "Current profile is not a token profile"; exit 1; }
  echo "${token}"
}

cmd_env() {
  local name type
  [[ -f "${CURRENT_FILE}" ]] && name="$(cat "${CURRENT_FILE}")" || { err "No profile active"; exit 1; }
  if is_token_profile "${name}"; then
    local token; token="$(get_current_token)" || { err "No token for '${name}'"; exit 1; }
    echo "export CLAUDE_CODE_OAUTH_TOKEN='${token}'"
  elif is_apikey_profile "${name}"; then
    local key; key="$(get_current_apikey)" || { err "No API key for '${name}'"; exit 1; }
    echo "export ANTHROPIC_API_KEY='${key}'"
  else
    dim "# OAuth profile - no environment variable needed (uses Keychain)"
  fi
}

cmd_refresh() {
  local quiet=false profiles=()
  while [[ $# -gt 0 ]]; do
    case "$1" in
      -q|--quiet) quiet=true; shift ;;
      *) profiles+=("$1"); shift ;;
    esac
  done
  mkdir -p "${PROFILES_DIR}"
  if [[ ${#profiles[@]} -eq 0 ]]; then
    for dir in "${PROFILES_DIR}"/*/; do
      [[ -d "${dir}" ]] || continue
      local name="${dir%/}"; name="${name##*/}"; profiles+=("${name}")
    done
  fi
  [[ ${#profiles[@]} -eq 0 ]] && { [[ "${quiet}" == "true" ]] || dim "No profiles to refresh."; return 0; }
  [[ "${quiet}" == "true" ]] || header "Refreshing Tokens"
  for name in "${profiles[@]}"; do refresh_profile_token "${name}" "${quiet}"; done
  [[ "${quiet}" == "true" ]] || echo ""
}

cmd_usage() {
  mkdir -p "${PROFILES_DIR}"; local found=0 current=""
  [[ -f "${CURRENT_FILE}" ]] && current="$(cat "${CURRENT_FILE}")"
  header "Usage by Profile"
  for dir in "${PROFILES_DIR}"/*/; do
    [[ -d "${dir}" ]] || continue; found=1
    local name="${dir%/}"; name="${name##*/}"
    local marker="" suffix=""
    [[ "${name}" == "${current}" ]] && marker="${C_GREEN}${SYM_STAR}${C_RESET} " && suffix=" ${C_GREEN}active${C_RESET}"
    if is_apikey_profile "${name}"; then
      echo -e "  ${marker}${C_BOLD}${name}${C_RESET}${suffix} ${C_DIM}(api-key)${C_RESET}"
    elif is_token_profile "${name}"; then
      echo -e "  ${marker}${C_BOLD}${name}${C_RESET}${suffix} ${C_DIM}(token)${C_RESET}"
    else
      local token; token="$(get_token "${dir}.credential")"
      if [[ -n "${token}" ]]; then
        local usage_data; usage_data="$(fetch_usage "${token}" 2>/dev/null)" || true
        if [[ -n "${usage_data}" ]]; then
          local u5 u7 r5 r7
          u5="$(echo "${usage_data}" | jq -r '.five_hour.utilization // 0 | floor')"
          u7="$(echo "${usage_data}" | jq -r '.seven_day.utilization // 0 | floor')"
          r5="$(echo "${usage_data}" | jq -r '.five_hour.resets_at // empty | .[0:16] | sub("T";" ")')"
          r7="$(echo "${usage_data}" | jq -r '.seven_day.resets_at // empty | .[0:16] | sub("T";" ")')"
          local c5="${C_GREEN}" c7="${C_GREEN}"
          [[ ${u5} -ge 50 ]] && c5="${C_YELLOW}"; [[ ${u5} -ge 80 ]] && c5="${C_RED}"
          [[ ${u7} -ge 50 ]] && c7="${C_YELLOW}"; [[ ${u7} -ge 80 ]] && c7="${C_RED}"
          echo -e "  ${marker}${C_BOLD}${name}${C_RESET}${suffix}"
          echo -e "    ${C_DIM}5h:${C_RESET} ${c5}${u5}%${C_RESET}  ${C_DIM}7d:${C_RESET} ${c7}${u7}%${C_RESET}"
        else
          echo -e "  ${marker}${C_BOLD}${name}${C_RESET}${suffix} ${C_DIM}(no data)${C_RESET}"
        fi
      else
        echo -e "  ${marker}${C_BOLD}${name}${C_RESET}${suffix} ${C_DIM}(no credential)${C_RESET}"
      fi
    fi
  done
  [[ ${found} -eq 0 ]] && dim "  No profiles saved."
  echo ""; true
}

cmd_status() {
  local version; version="$(get_version)"
  echo -e "${C_BOLD}cwtch${C_RESET} ${C_DIM}v${version}${C_RESET}"

  local name="(none)" type="oauth" token=""
  [[ -f "${CURRENT_FILE}" ]] && name="$(cat "${CURRENT_FILE}")"
  is_apikey_profile "${name}" && type="api-key"
  is_token_profile "${name}" && type="token"

  # Profile section
  header "Profile"
  if [[ "${name}" == "(none)" ]]; then
    echo -e "  ${C_DIM}No profile active${C_RESET}"
    echo ""
    dim "  Get started:"
    echo -e "    ${C_CYAN}cwtch profile setup <name>${C_RESET}"
  else
    echo -e "  ${C_GREEN}${SYM_STAR}${C_RESET} ${C_BOLD}${name}${C_RESET} ${C_DIM}(${type})${C_RESET}"
    if [[ "${type}" == "api-key" ]]; then
      dim "    API key profiles have no usage data"
    elif [[ "${type}" == "token" ]]; then
      dim "    Token profiles have no usage data"
    else
      token="$(get_token "${PROFILES_DIR}/${name}/.credential" 2>/dev/null)" || true
      if [[ -n "${token}" ]]; then
        local usage_data; usage_data="$(fetch_usage "${token}" 2>/dev/null)" || true
        if [[ -n "${usage_data}" ]]; then
          local u5 u7 r5 r7
          u5="$(echo "${usage_data}" | jq -r '.five_hour.utilization // 0 | floor')"
          u7="$(echo "${usage_data}" | jq -r '.seven_day.utilization // 0 | floor')"
          r5="$(echo "${usage_data}" | jq -r '.five_hour.resets_at // empty | .[0:16] | sub("T";" ")')"
          r7="$(echo "${usage_data}" | jq -r '.seven_day.resets_at // empty | .[0:16] | sub("T";" ")')"
          # Color based on usage level
          local c5="${C_GREEN}" c7="${C_GREEN}"
          [[ ${u5} -ge 50 ]] && c5="${C_YELLOW}"; [[ ${u5} -ge 80 ]] && c5="${C_RED}"
          [[ ${u7} -ge 50 ]] && c7="${C_YELLOW}"; [[ ${u7} -ge 80 ]] && c7="${C_RED}"
          echo -e "    ${C_DIM}5h:${C_RESET}  ${c5}${u5}%${C_RESET} ${C_DIM}resets ${r5} UTC${C_RESET}"
          echo -e "    ${C_DIM}7d:${C_RESET}  ${c7}${u7}%${C_RESET} ${C_DIM}resets ${r7} UTC${C_RESET}"
        else
          dim "    Could not fetch usage data"
        fi
      else
        dim "    No credential found"
      fi
    fi
  fi

  # Sources section
  header "Sources"
  if config_exists; then
    local idx
    for idx in $(config_source_indices); do
      local repo as; repo="$(config_source_get "${idx}" repo)"; as="$(config_source_get "${idx}" as)"
      local path; path="$(repo_local_path "${repo}")"
      if [[ -d "${path}/.git" ]]; then
        local commit; commit="$(git -C "${path}" log -1 --format='%h' 2>/dev/null || echo '?')"
        echo -e "  ${C_GREEN}${SYM_CHECK}${C_RESET} ${repo} ${C_CYAN}${SYM_ARROW}${C_RESET} ${C_BOLD}${as:-"(root)"}${C_RESET} ${C_DIM}[${commit}]${C_RESET}"
      else
        echo -e "  ${C_YELLOW}${SYM_DOT}${C_RESET} ${repo} ${C_CYAN}${SYM_ARROW}${C_RESET} ${as:-"(root)"} ${C_YELLOW}not synced${C_RESET}"
      fi
    done
    echo ""
    dim "  Config: ${CWTCHFILE}"
    local overlay; overlay="$(config_profile_overlay "${name}")"
    [[ -n "${overlay}" ]] && dim "  Overlay: ${overlay}"
  else
    dim "  Not configured"
    echo -e "  Run ${C_CYAN}cwtch sync init${C_RESET} to get started"
  fi
  echo ""
}

main() {
  [[ $# -lt 1 ]] && { usage_help; exit 0; }
  local cmd="$1"; shift
  case "${cmd}" in
    status) cmd_status ;;
    usage) cmd_usage ;;
    refresh) cmd_refresh "$@" ;;
    sync) cmd_sync "$@" ;;
    profile) cmd_profile "$@" ;;
    edit) "${EDITOR:-vi}" "${CWTCHFILE}" ;;
    version|--version|-v) cmd_version ;;
    -h|--help) usage_help ;;
    *) err "Unknown: ${cmd}"; usage_help; exit 1 ;;
  esac
}

main "$@"
